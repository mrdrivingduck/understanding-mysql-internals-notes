# Chapter 1 - MySQL History and Architecture

Created by : Mr Dk.

2021 / 03 / 25 19:51

Nanjing, Jiangsu, China

---

## History

* MySQL 1.0 - 1996.05
* MySQL 3.11.1 - 1996.10
* MySQL 3.22 - 支持相当一部分的 SQL 语句，优化器，表级锁
* MySQL 3.23 - 集成 *Berkeley DB* 引擎，并为集成其它引擎提供了钩子
* MySQL 4.0 - 2000.04 - 主从复制、非事物引擎 *ISAM* 被重构为 *MyISAM*、集成了支持事物和行级锁的 *InnoDB* 引擎、查询缓存
* MySQL 4.1 - 2003.04 - 子查询、空间索引、支持 Unicode
* MySQL 5.0 - 2005.10 - 存储过程、服务端指针、触发器、视图、XA 事物、改进查询优化器

## MySQL Architecture

### Core Modules

此处的 **模块** 特指在逻辑上同属一个功能的代码 (可能位于不同的源代码文件中)。

* 服务器初始化模块
* 连接管理模块 - 监听服务器端口，并将请求分发给线程管理模块
* 线程管理模块 - 为客户端连接分配处理线程
* 连接线程
* 用户认证模块 - 初始化包含用户特权级的结构和变量
* 访问控制模块 - 认证客户端是否有足够的权限执行请求操作
* 词法分析模块 - 对请求进行词法分析，生成语法树
* 命令分发模块 - 将请求定向到低层模块
* 查询缓存模块
* 优化器模块 - 产生最佳的查询策略
* 表管理模块 - 创建 / 读取 / 修改表定义文件 (`/frm`)
* 表修改模块 - 表的创建 / 删除 / 重命名 / 释放 / 更新 / 插入
* 表维护模块 - 表的校验 / 修复 / 备份 / 导入 / 分片 / 分析
* 状态报告模块 - 回应 `SHOW` 开头的查询命令
* 抽象存储引擎接口 - 提供进行低层存储和获取操作的标准化接口 (纯虚函数)
* 存储引擎实现
* 日志模块 - 负责维护高层逻辑日志 (非存储引擎级别) (binary update log / command log / slow query log)
* 复制 (主 / 从) 模块
* 客户端 / 服务器协议模块
* 低层网络 I/O 模块 - 提供低层网络 I/O 的抽象 (方便移植)
* 核心 API - MySQL 的 *瑞士军刀*

### Interaction of the Core Modules

> 各个模块之间是如何作用的呢？

服务器从命令行启动，**初始化模块** 接管控制。初始化模块解析配置文件和命令行参数、分配全局内存缓冲、初始化全局变量和结构、加载访问控制表...初始化完毕后，将控制权交给 **连接管理模块**，在循环中监听客户端连接。

当客户端连接到数据库服务器后，连接管理模块将控制权交给 **线程管理模块**，后者提供一个线程来对连接进行处理。**连接线程** 接管控制后，首先调用 **用户认证模块** 检验用户能否发送请求。连接线程将客户端请求传递给 **命令分发模块**。在 MySQL 服务器端，有两种类型的客户端请求。**查询** 特指需要通过词法分析器的所有请求；**命令** 特指不需要经过词法分析的所有请求。命令分发模块可以直接处理部分命令；而对于复杂的查询，需要转发给其它模块。如果全文查询日志启用，在命令被分发前，命令分发模块将在分发前要求 **日志模块** 以明文形式记录查询或命令。

命令分发模块经由 **查询缓存模块** 将查询转发到 **词法分析模块**。如果之前的查询结果已经被缓存，并依旧合法，那么可以直接返回查询结果，此时连接线程重新接管控制，等待下一条命令；否则，词法分析模块根据查询的类型，决定将查询转发到哪个模块。`SELECT` 查询将会被转发至 **优化器模块**；`UPDATE` / `INSERT` / `DELETE` / 表创建 / 模式修改查询将会被转发到 **表修改模块**；对表进行检查、修复或分片的查询将会被转发至 **表维护模块**；与复制相关的查询将会被转发到 **复制模块**；与状态查询有关的请求将会被转发到 **状态报告模块**。

在请求经过 **访问控制模块** 后，在 **表管理模块** 中打开表，并获得必要的锁。此时，表操作模块已经准备好处理任务了。表操作模块将会向 **抽象存储引擎模块** 发送低层请求，抽象存储引擎通过多态将请求翻译为具体存储引擎的操作。抽象存储引擎的函数都是 `virtual` 的。当执行遇到错误时，服务器立刻将控制权交给连接线程，向客户端返回错误信息。

如果低层模块对数据进行了修改，并且二进制日志 (binlog) 功能被开启，那么 **日志模块** 将会记录二进制日志。二进制日志同时也会被作为重放日志。

任务完成后，执行流回到连接线程中。进行必要的清理后，等待客户端的下一次查询，直到客户端发送 `QUIT` 命令。除了与常规客户端进行交互，服务器还可能会接收到来自备份从结点的读取 binlog 的请求。这些命令由 **复制主模块** 管理。

如果服务器被配置为复制从结点，那么初始化模块会将控制流转移到 **复制从模块**，启动两个线程：SQL 线程、I/O 线程，负责从结点与主结点的同步：I/O 线程负责向主结点请求 binlog，并将内容记录到一个本地的重放日志中；SQL 线程负责读取本地重放日志中，并应用到结点的数据上。

服务器与客户端的通信将会经过 **网络通信模块**，负责将数据打包为相应的格式并压缩。模块使用低层的 I/O 模块，在 socket 层上以跨平台可移植的方式收发数据。另外，还会使用 *OpenSSL* 库来加密数据。

以上所有模块全都严重依赖于 **核心 API**。核心 API 提供了文件 I/O、内存管理、字符串处理、数据结构和算法等实现。MySQL 开发人员被鼓励尽量不要使用 *libc* 库，而是尽可能使用核心 API，以方便代码移植和优化。

---

